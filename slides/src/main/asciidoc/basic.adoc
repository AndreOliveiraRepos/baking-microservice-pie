ifndef::imagesdir[:imagesdir: images]

= Let's start simple

[%step]
* We have one Number API Micro Service
* We have one Angular client
* We use 2 Pis
* How do we deploy and make this run?

== Architecture

image::basic-architecture.png[]

== Number API

[%step]
* JAX-RS Endpoint
* Generates random numbers
* Just an HTTP GET on:
* `/numbers/book`
* Port 8084
* Exposes a Swagger contract

== Number API

[source,java]
----
include::{demo01numberapidir}/src/main/java/org/bakingpie/number/rest/NumberResource.java[tags=adocSnippet;!adocSkip;!adocSwagger]
----

== Running on Wildfly Swarm

[%step]
* Comes from Wildfly (RedHat)
* Small fractions
* Executable Jar
* xxx

== Angular app

[%step]
* Angular
* Bootstrap
* (_because we are bad web designers_)
* Port 8080
* Invokes the `number-api` through HTTP
* Thanks to the Swagger contract

== Swagger

image::swagger.jpg[]

== Swagger

[%step]
* Open API Specification
* API documentation
* What do you call?
* What are the parameters?
* What are the status code?
* Contract written in JSon (or Yaml)

== Swagger Annotations

[source,java]
----
include::{demo01numberapidir}/src/main/java/org/bakingpie/number/rest/NumberResource.java[tags=adocSnippet;!adocSkip]
----

== Swagger Contract

[source,json]
----
include::{demo01numberapidir}/src/main/webapp/swagger.json[]
----

== Swagger Ecosystem

image::swagger-eco.png[]

== Swagger Code Gen

[%step]
* Generates code from a Swagger contract
* Client stubs
* Several languages
* Including TypeScript for Angular
* `$ swagger-codegen generate -i swagger.json -l typescript-angular2 -o src/app/shared`

== The Generated TypeScript Service

[source,js]
----
include::{demo01angulardir}/src/app/shared/api/NumbersApi.ts[tags=adocSnippet;!adocSkip]
----

== CORS

[%step]
* Cross-Origin Resource Sharing
* Specification (https://www.w3.org/TR/cors/)
* Access across domain-boundaries
* Number API and Angular app on different machines

== Solving CORS

[%step]
* Network configuration
* JAX-RS ContainerResponseFilter
* Servlet Filter

== CORS Servlet Filter

[source,java]
----
include::{commonscorsdir}/src/main/java/org/bakingpie/commons/web/CORSFilter.java[tags=adocSnippet;!adocSkip]
----

== CORS Servlet Filter

[source,xml,indent=0]
----
include::{demo01numberapidir}/src/main/webapp/WEB-INF/web.xml[tags=adocSnippet]
----

== Demo (Local)

image::basic-architecture-local.png[]

== Deploy

[%step]
* Package everything with Docker
* Use Docker registry
* Push it to the PIs with Ansible

== Docker

[%step]
* Everything is packaged with Docker
* Using Maven Fabric8 Plugin

== Docker Registry

[%step]
* Everything is packaged with Docker
* Using Maven Fabric8 Plugin

== Maven building with Docker

[source,shell]
----
mvn clean install docker:build docker:push
----

== Docker Compose

[%step]
* All components in one file
* Easy to run in development
* But you don't do that in production

== docker-compose.yml

[source,yml]
----
include::{demo02dir}/docker-compose.yml[]
----

== HypriotOS

[%step]
* Minimal Debian-based operating systems
* Optimized to run Docker on Raspberry PIs

== Ansible

[%step]
* xxx
* Playbook
* sshpass a bit touchy on security

== Pinging all the PIs

[source,shell]
----
ansible -i ansible/hosts -m ping all
----

== Deploying on the PIs

[source,shell]
----
ansible-playbook ansible/deploy.yaml -i ansible/hosts
----

== Demo (PIs)

image::basic-architecture.png[]

== What's next ?

[%step]
* Adding more micro-services

